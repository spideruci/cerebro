<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Space Demo</title>
    <link href="stylesheets/screen.css" media="all" rel="stylesheet" type="text/css"/>
    <script language="javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js" type="text/javascript"></script>
    <script language="javascript" src="javascripts/jquery.hotkeys.js" type="text/javascript"></script>
    <script language="javascript" src="javascripts/key_status.js" type="text/javascript"></script>
    <script language="javascript" src="javascripts/util.js" type="text/javascript"></script>
    <script language="javascript" src="javascripts/sprite.js" type="text/javascript"></script>
    <script language="javascript" src="javascripts/sound.js" type="text/javascript"></script>
  </head>
  <body>
    <h1>Space Demo</h1>
    <script type='text/javascript'>
      var CANVAS_WIDTH = 1000;
      var CANVAS_HEIGHT = 320;
      var playerBullets = [];
      var canvasElement = $("<canvas width='" + CANVAS_WIDTH + "' height='" + CANVAS_HEIGHT + "'></canvas>");
      var canvas = canvasElement.get(0).getContext("2d");
      canvasElement.appendTo('body');
      var FPS = 30;
      
      setInterval(function() {
        update();
        draw();
      }, 1000/FPS);

      var textx = 50;
      var texty = 50;

      var update = function() { 
        textx = (textx + 1) % CANVAS_WIDTH;
        texty = (texty + 1) % CANVAS_HEIGHT;
        
        if (keydown.left) {
          player.rotate_left();
        }

        if (keydown.right) {
          player.rotate_right();
        }

        if (keydown.up) {
          player.x = (player.x + (player.speed*Math.cos(player.angle*Math.PI/180))) % CANVAS_WIDTH;
          player.y = (player.y + (player.speed*Math.sin(player.angle*Math.PI/180))) % CANVAS_HEIGHT;

          if(player.x <= -player.width) {
            player.x = CANVAS_WIDTH;
          }
          if(player.y <= -player.height) {
            player.y = CANVAS_HEIGHT;
          }

          // player.accelerate();
        }

        if (keydown.down) {
          player.x = player.x - (player.speed*Math.cos(player.angle*Math.PI/180)) % CANVAS_WIDTH;
          player.y = player.y - (player.speed*Math.sin(player.angle*Math.PI/180)) % CANVAS_HEIGHT;
          
          if(player.x <= -player.width) {
            player.x = CANVAS_WIDTH;
          }
          if(player.y <= -player.height) {
            player.y = CANVAS_HEIGHT;
          }

          // player.decelerate();
          // player.y = (player.y + player.speed) % CANVAS_HEIGHT;
        }

        if (keydown.a) {
          player.accelerate();
        }

        if (keydown.d) {
          player.decelerate();
        }

        if (keydown.space) {
          player.shoot();
        }

        playerBullets.forEach(function(bullet) {
          bullet.update();
        });

        playerBullets = playerBullets.filter(function(bullet) {
          return bullet.active;
        });

      };

      var draw = function() {
        
        canvas.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        
        // canvas.fillStyle = "#0000FF"; // Set color to black
        // canvas.fillText("Sup Bro!", textx, texty);
        player.draw();

        playerBullets.forEach(function(bullet) {
          bullet.draw();
        });
      };

      
      
      var player = {
        color: "#00A",
        x: 0,
        y: 0,
        width: 32,
        height: 32,
        speed: 5,
        angle: 0,
        draw: function() {
          canvas.save();
          var xpos = this.x + this.width/2;
          var ypos = this.y + this.height/2;
          
          canvas.translate(xpos, ypos);
          canvas.rotate(this.angle*Math.PI/180);  // rotate 90 degrees
          canvas.translate(-xpos, -ypos);

          canvas.fillStyle = this.color;
          canvas.fillRect(this.x, this.y, this.width, this.height);
          canvas.fillStyle = "#F00";
          canvas.fillRect(xpos, ypos, this.width/2, 1);
          canvas.restore();

        },
        rotate_right: function() {
          this.color = "#0A0";
          this.angle = (this.angle + 5) % 360;
        },
        rotate_left: function() {
          this.color = "#0A0";
          this.angle = (this.angle - 5) % 360;
        },
        accelerate : function() {
          this.speed += 1;
        },
        decelerate : function() {
          this.speed -= 1;
        },
        midpoint : function() {
          return {
            x: this.x + this.width/2,
            y: this.y + this.height/2
          };
        },
        shoot : function() {
          var bulletPosition = this.midpoint();
          playerBullets.push(Bullet({
            speed: 5,
            x: bulletPosition.x,
            y: bulletPosition.y
          }));
        }
      };

      function Bullet(I) {
        I.active = true;

        I.xVelocity = 0;
        I.yVelocity = -I.speed;
        I.width = 3;
        I.height = 3;
        I.color = "#000";

        I.inBounds = function() {
          return I.x >= 0 && I.x <= CANVAS_WIDTH &&
            I.y >= 0 && I.y <= CANVAS_HEIGHT;
        };

        I.draw = function() {
          canvas.fillStyle = this.color;
          canvas.fillRect(this.x, this.y, this.width, this.height);
        };

        I.update = function() {
          I.x += I.xVelocity;
          I.y += I.yVelocity;
          I.active = I.active && I.inBounds();
        };

        return I;
      };

      var collides = function(a, b) {
       return a.x < b.x + b.width &&
             a.x + a.width > b.x &&
             a.y < b.y + b.height &&
             a.y + a.height > b.y;
      }

    </script>
  </body>
</html>
